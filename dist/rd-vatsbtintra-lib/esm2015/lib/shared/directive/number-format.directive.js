import { Directive, forwardRef, Input, HostListener, Inject } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { DOCUMENT } from '@angular/common';
import * as i0 from "@angular/core";
export class NumberFormatDirective {
    constructor(el, document) {
        this.el = el;
        this.document = document;
        this.isZero = false;
        this._oldValueForDetectChange = '';
        this._oldValue = '';
        this._displayValue = '';
        this._max = 0;
        this._decimal = 0;
        this._format = false;
        this._specialKeys = ['Backspace', 'Tab', 'End', 'Home', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', 'Delete'];
        this._regExNumber = new RegExp(/^[0-9]*$/g);
        this._regExNumberAndDecimal = new RegExp(/^[0-9]+(\.[0-9]*){0,1}$/g);
        this._oldSelectionStart = 0;
        this._detectDelete = false;
        this._detectBackspace = false;
        this._regExNumberNotZero = new RegExp(/^[1-9]\d*$/g);
        this.onChange = (_) => { };
        this.onTouch = () => { };
    }
    ngOnInit() {
        this._formElement = this.el.nativeElement;
    }
    set initialize(_value) {
        if (_value.indexOf(',') !== -1) {
            this._format = true;
        }
        _value = _value.replace(/,/g, '');
        const data = _value.split('.');
        if (data.length === 1) {
            this._max = data[0].length;
        }
        else if (data.length === 2) {
            this._max = data[0].length;
            this._decimal = data[1].length;
        }
        else {
            throw new Error('Wrong format number.');
        }
    }
    onKeyDown(event) {
        if (event.key === 'Backspace') {
            this._detectBackspace = true;
            if (this._formElement.selectionStart) {
                const last = this._formElement.value.substring(this._formElement.selectionStart - 1, this._formElement.selectionStart);
                if (this._formElement.selectionStart === this._formElement.selectionEnd && last === ',') {
                    this.setCursorAt(this._formElement.selectionStart - 1);
                    event.preventDefault();
                }
            }
        }
        else {
            this._detectBackspace = false;
        }
        if (event.key === 'Delete') {
            this._detectDelete = true;
            if (this._formElement.selectionEnd) {
                const last = this._formElement.value.substring(this._formElement.selectionEnd, this._formElement.selectionEnd + 1);
                if (this._formElement.selectionStart === this._formElement.selectionEnd && last === ',') {
                    this.setCursorAt(this._formElement.selectionEnd + 1);
                    event.preventDefault();
                }
            }
        }
        else {
            this._detectDelete = false;
        }
        if (this._specialKeys.indexOf(event.key) !== -1
            || (event.keyCode === 65 && (event.ctrlKey || event.metaKey)) // Allow: Ctrl + A
            || (event.keyCode === 67 && (event.ctrlKey || event.metaKey)) // Allow: Ctrl + C
            || (event.keyCode === 86 && (event.ctrlKey || event.metaKey)) // Allow: Ctrl + V
            || (event.keyCode === 88 && (event.ctrlKey || event.metaKey)) // Allow: Ctrl + X
        ) {
            return;
        }
        // Fix Chrome on Android event key not forword to event by get exact output from current cursor on text input
        let keyPressed = event.key;
        let kc = event.which || event.keyCode;
        if (!kc || kc === 229) {
            const ss = this._formElement.selectionStart ? this._formElement.selectionStart - 1 : 0;
            const ssv = ss || 0;
            keyPressed = this._formElement.value.substring(ssv, ssv + 1);
            kc = keyPressed.charCodeAt(0);
        }
        // Fix IE got dot in numeric area key as Decimal
        if (keyPressed === 'Decimal') {
            keyPressed = '.';
        }
        const current = this.el.nativeElement.value;
        const firstPart = current.substring(0, this._formElement.selectionStart || 0);
        const secondPart = current.substring(this._formElement.selectionEnd || 0);
        const next = (firstPart.concat(keyPressed) + secondPart).replace(/,/g, '');
        const regEx = this.getRegEx();
        const value = next.split('.');
        if (next && !String(next).match(regEx) || (value[0].length > this._max && this._formElement.selectionStart === this._formElement.selectionEnd) || (this._decimal > 0 && value.length === 2 && (value[1].length > this._decimal && this._formElement.selectionStart === this._formElement.selectionEnd))) {
            event.preventDefault();
        }
        else {
            if (this._formElement.selectionStart) {
                this._oldSelectionStart = this._formElement.selectionStart;
            }
            this._oldValue = this._formElement.value;
        }
    }
    onClick(event) {
        if (this._formElement.selectionStart) {
            this._oldSelectionStart = this._formElement.selectionStart;
        }
        this._oldValue = this._formElement.value;
        this._oldValueForDetectChange = event.target.value;
    }
    onInput(event) {
        const value = event.target.value;
        if (value && !String(value).replace(/,/g, '').match(this.getRegEx())) {
            this._formElement.value = '';
        }
        else {
            if (this._detectBackspace || this._detectDelete) {
                if (this._formElement.selectionStart) {
                    this._oldSelectionStart = this._formElement.selectionStart - 1;
                }
                this._oldValue = this._formElement.value;
            }
            this.onValueChange(value);
        }
    }
    onBlur(event) {
        let value = event.target.value;
        if (value.length > 0 && this._decimal > 0) {
            value = value.replace(/,/g, '');
            value = Number(value).toFixed(this._decimal).toString();
            this._formElement.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        this.onTouch();
        // Fix bug on Internet Explorer and Microsoft Edge not fire change event when set value to input element by javascript.
        // *** 24/12/2021 *** Add IOS Device not fire change event
        const isIEOrEdge = /msie\s|trident\/|edge\//i.test(window.navigator.userAgent) || this.detectIOS();
        if (isIEOrEdge && (value !== this._oldValueForDetectChange)) {
            const evt = document.createEvent('HTMLEvents');
            evt.initEvent('change', false, true);
            event.target.dispatchEvent(evt);
        }
    }
    detectIOS() {
        return ['MacIntel', 'MacPPC', 'Mac68K', 'Macintosh', 'iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod', 'Pike v7.6 release 92', 'Pike v7.8 release 517'].includes(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    }
    processCursorPosition(_oldValue, _oldSelectionStart, _newValue) {
        let _oldTotalComma = 0;
        let _newTotalComma = 0;
        if (_newValue) {
            _oldValue = _oldValue.substring(0, _oldSelectionStart);
            _oldTotalComma = (_oldValue.match(/,/g) || []).length;
            _newValue = _newValue.substring(0, _oldSelectionStart + 1);
            _newTotalComma = (_newValue.match(/,/g) || []).length;
            this.setCursorAt(_oldSelectionStart + 1 + (_newTotalComma - _oldTotalComma));
        }
    }
    setCursorAt(position) {
        if (this._formElement.setSelectionRange) {
            this._formElement.focus();
            this._formElement.setSelectionRange(position, position);
        }
    }
    writeValue(value) {
        if (value != null && value !== '') {
            if (typeof (value) === 'string') {
                value = value.replace(/,/g, '');
            }
            if (this._decimal > 0) {
                value = Number(value).toFixed(this._decimal);
            }
            value = value.toString();
        }
        this.onValueChange(value, false);
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouch = fn;
    }
    setDisabledState(value) {
        this._formElement.disabled = value;
    }
    onValueChange(newValue, cursor = true) {
        if (newValue !== this._displayValue) {
            let value;
            if ((typeof (newValue) !== 'string') && newValue !== null) {
                newValue = newValue + '';
                newValue = Number(newValue).toFixed(this._decimal).toString();
            }
            if ((newValue == null) || (newValue.trim() === '')) {
                value = '';
            }
            else {
                value = newValue.replace(/,/g, '');
                value = this.removeLeadingZero(value);
            }
            if (this._format) {
                this._displayValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            else {
                this._displayValue = value;
            }
            this._formElement.value = this._displayValue;
            this.onChange(value);
            if (cursor) {
                this.processCursorPosition(this._oldValue, this._oldSelectionStart, this._displayValue);
            }
        }
    }
    removeLeadingZero(value) {
        if (value.indexOf('.') === -1) {
            const convertVal = +value;
            value = convertVal.toString();
        }
        return value;
    }
    getRegEx() {
        return (this._decimal > 0) ? this._regExNumberAndDecimal : (this.isZero === true ? this._regExNumber : this._regExNumberNotZero);
    }
}
NumberFormatDirective.ɵfac = function NumberFormatDirective_Factory(t) { return new (t || NumberFormatDirective)(i0.ɵɵdirectiveInject(i0.ElementRef), i0.ɵɵdirectiveInject(DOCUMENT)); };
NumberFormatDirective.ɵdir = i0.ɵɵdefineDirective({ type: NumberFormatDirective, selectors: [["", "libNumberFormat", ""]], hostBindings: function NumberFormatDirective_HostBindings(rf, ctx) { if (rf & 1) {
        i0.ɵɵlistener("keydown", function NumberFormatDirective_keydown_HostBindingHandler($event) { return ctx.onKeyDown($event); })("click", function NumberFormatDirective_click_HostBindingHandler($event) { return ctx.onClick($event); })("input", function NumberFormatDirective_input_HostBindingHandler($event) { return ctx.onInput($event); })("blur", function NumberFormatDirective_blur_HostBindingHandler($event) { return ctx.onBlur($event); });
    } }, inputs: { isZero: "isZero", initialize: ["libNumberFormat", "initialize"] }, features: [i0.ɵɵProvidersFeature([
            {
                provide: NG_VALUE_ACCESSOR,
                useExisting: forwardRef(() => NumberFormatDirective),
                multi: true
            }
        ])] });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(NumberFormatDirective, [{
        type: Directive,
        args: [{
                selector: '[libNumberFormat]',
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => NumberFormatDirective),
                        multi: true
                    }
                ]
            }]
    }], function () { return [{ type: i0.ElementRef }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, { isZero: [{
            type: Input
        }], initialize: [{
            type: Input,
            args: ['libNumberFormat']
        }], onKeyDown: [{
            type: HostListener,
            args: ['keydown', ['$event']]
        }], onClick: [{
            type: HostListener,
            args: ['click', ['$event']]
        }], onInput: [{
            type: HostListener,
            args: ['input', ['$event']]
        }], onBlur: [{
            type: HostListener,
            args: ['blur', ['$event']]
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnVtYmVyLWZvcm1hdC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9yZC12YXRzYnRpbnRyYS1saWIvc3JjL2xpYi9zaGFyZWQvZGlyZWN0aXZlL251bWJlci1mb3JtYXQuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsVUFBVSxFQUFjLEtBQUssRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7O0FBWTNDLE1BQU0sT0FBTyxxQkFBcUI7SUFvQjlCLFlBQW9CLEVBQWMsRUFBNEIsUUFBYTtRQUF2RCxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQTRCLGFBQVEsR0FBUixRQUFRLENBQUs7UUFuQmxFLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFDaEIsNkJBQXdCLEdBQUcsRUFBRSxDQUFDO1FBQzlCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixrQkFBYSxHQUFHLEVBQUUsQ0FBQztRQUNuQixTQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ1QsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFaEIsaUJBQVksR0FBa0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN4SSxpQkFBWSxHQUFXLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQy9DLDJCQUFzQixHQUFXLElBQUksTUFBTSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEUsdUJBQWtCLEdBQUcs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YUFDSjs7c0JBcUJ3QyxNQUFNO3VCQUFDLFFBQVE7d0JBbkIzQyxNQUFNO2tCQUFkLEtBQUs7WUEwQkssVUFBVTtrQkFEcEIsS0FBSzttQkFBQyxpQkFBaUI7WUFxQnhCLFNBQVM7a0JBRFIsWUFBWTttQkFBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7WUEwRTVCLE9BQU87a0JBRGIsWUFBWTttQkFBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUM7WUFVMUIsT0FBTztrQkFEYixZQUFZO21CQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQztZQW1CMUIsTUFBTTtrQkFEWixZQUFZO21CQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBmb3J3YXJkUmVmLCBFbGVtZW50UmVmLCBJbnB1dCwgSG9zdExpc3RlbmVyLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2xpYk51bWJlckZvcm1hdF0nLFxyXG4gICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcclxuICAgICAgICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTnVtYmVyRm9ybWF0RGlyZWN0aXZlKSxcclxuICAgICAgICAgICAgbXVsdGk6IHRydWVcclxuICAgICAgICB9XHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOdW1iZXJGb3JtYXREaXJlY3RpdmUgaW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvciwgT25Jbml0IHtcclxuICAgIEBJbnB1dCgpIGlzWmVybyA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfb2xkVmFsdWVGb3JEZXRlY3RDaGFuZ2UgPSAnJztcclxuICAgIHByaXZhdGUgX29sZFZhbHVlID0gJyc7XHJcbiAgICBwcml2YXRlIF9kaXNwbGF5VmFsdWUgPSAnJztcclxuICAgIHByaXZhdGUgX21heCA9IDA7XHJcbiAgICBwcml2YXRlIF9kZWNpbWFsID0gMDtcclxuICAgIHByaXZhdGUgX2Zvcm1hdCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfZm9ybUVsZW1lbnQhOiBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgcHJpdmF0ZSBfc3BlY2lhbEtleXM6IEFycmF5PHN0cmluZz4gPSBbJ0JhY2tzcGFjZScsICdUYWInLCAnRW5kJywgJ0hvbWUnLCAnQXJyb3dVcCcsICdBcnJvd0Rvd24nLCAnQXJyb3dMZWZ0JywgJ0Fycm93UmlnaHQnLCAnRW50ZXInLCAnRGVsZXRlJ107XHJcbiAgICBwcml2YXRlIF9yZWdFeE51bWJlcjogUmVnRXhwID0gbmV3IFJlZ0V4cCgvXlswLTldKiQvZyk7XHJcbiAgICBwcml2YXRlIF9yZWdFeE51bWJlckFuZERlY2ltYWw6IFJlZ0V4cCA9IG5ldyBSZWdFeHAoL15bMC05XSsoXFwuWzAtOV0qKXswLDF9JC9nKTtcclxuICAgIHByaXZhdGUgX29sZFNlbGVjdGlvblN0YXJ0ID0gMDtcclxuICAgIHByaXZhdGUgX2RldGVjdERlbGV0ZSA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfZGV0ZWN0QmFja3NwYWNlID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIF9yZWdFeE51bWJlck5vdFplcm86IFJlZ0V4cCA9IG5ldyBSZWdFeHAoL15bMS05XVxcZCokL2cpO1xyXG5cclxuICAgIHB1YmxpYyBvbkNoYW5nZSA9IChfOiBhbnkpID0+IHsgfTtcclxuICAgIHB1YmxpYyBvblRvdWNoID0gKCkgPT4geyB9O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IGFueSkgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5fZm9ybUVsZW1lbnQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgQElucHV0KCdsaWJOdW1iZXJGb3JtYXQnKVxyXG4gICAgcHVibGljIHNldCBpbml0aWFsaXplKF92YWx1ZTogc3RyaW5nKSB7XHJcblxyXG4gICAgICAgIGlmIChfdmFsdWUuaW5kZXhPZignLCcpICE9PSAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLl9mb3JtYXQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdmFsdWUgPSBfdmFsdWUucmVwbGFjZSgvLC9nLCAnJyk7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IF92YWx1ZS5zcGxpdCgnLicpO1xyXG5cclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgdGhpcy5fbWF4ID0gZGF0YVswXS5sZW5ndGg7XHJcbiAgICAgICAgfSBlbHNlIGlmIChkYXRhLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgICAgICB0aGlzLl9tYXggPSBkYXRhWzBdLmxlbmd0aDtcclxuICAgICAgICAgICAgdGhpcy5fZGVjaW1hbCA9IGRhdGFbMV0ubGVuZ3RoO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV3JvbmcgZm9ybWF0IG51bWJlci4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxyXG4gICAgb25LZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XHJcblxyXG4gICAgICAgIGlmIChldmVudC5rZXkgPT09ICdCYWNrc3BhY2UnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2RldGVjdEJhY2tzcGFjZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25TdGFydCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFzdDogc3RyaW5nID0gdGhpcy5fZm9ybUVsZW1lbnQudmFsdWUuc3Vic3RyaW5nKHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0IC0gMSwgdGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0ID09PSB0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQgJiYgbGFzdCA9PT0gJywnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXJzb3JBdCh0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25TdGFydCAtIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9kZXRlY3RCYWNrc3BhY2UgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldmVudC5rZXkgPT09ICdEZWxldGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2RldGVjdERlbGV0ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3Q6IHN0cmluZyA9IHRoaXMuX2Zvcm1FbGVtZW50LnZhbHVlLnN1YnN0cmluZyh0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQsIHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvbkVuZCArIDEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0ID09PSB0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQgJiYgbGFzdCA9PT0gJywnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXJzb3JBdCh0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQgKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fZGV0ZWN0RGVsZXRlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHRoaXMuX3NwZWNpYWxLZXlzLmluZGV4T2YoZXZlbnQua2V5KSAhPT0gLTFcclxuICAgICAgICAgICAgfHwgKGV2ZW50LmtleUNvZGUgPT09IDY1ICYmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSAvLyBBbGxvdzogQ3RybCArIEFcclxuICAgICAgICAgICAgfHwgKGV2ZW50LmtleUNvZGUgPT09IDY3ICYmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSAvLyBBbGxvdzogQ3RybCArIENcclxuICAgICAgICAgICAgfHwgKGV2ZW50LmtleUNvZGUgPT09IDg2ICYmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSAvLyBBbGxvdzogQ3RybCArIFZcclxuICAgICAgICAgICAgfHwgKGV2ZW50LmtleUNvZGUgPT09IDg4ICYmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSAvLyBBbGxvdzogQ3RybCArIFhcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRml4IENocm9tZSBvbiBBbmRyb2lkIGV2ZW50IGtleSBub3QgZm9yd29yZCB0byBldmVudCBieSBnZXQgZXhhY3Qgb3V0cHV0IGZyb20gY3VycmVudCBjdXJzb3Igb24gdGV4dCBpbnB1dFxyXG4gICAgICAgIGxldCBrZXlQcmVzc2VkID0gZXZlbnQua2V5O1xyXG4gICAgICAgIGxldCBrYyA9IGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGU7XHJcbiAgICAgICAgaWYgKCFrYyB8fCBrYyA9PT0gMjI5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNzID0gdGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQgPyB0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25TdGFydCAtIDEgOiAwO1xyXG4gICAgICAgICAgICBjb25zdCBzc3YgPSBzcyB8fCAwO1xyXG4gICAgICAgICAgICBrZXlQcmVzc2VkID0gdGhpcy5fZm9ybUVsZW1lbnQudmFsdWUuc3Vic3RyaW5nKHNzdiwgc3N2ICsgMSk7XHJcbiAgICAgICAgICAgIGtjID0ga2V5UHJlc3NlZC5jaGFyQ29kZUF0KDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRml4IElFIGdvdCBkb3QgaW4gbnVtZXJpYyBhcmVhIGtleSBhcyBEZWNpbWFsXHJcbiAgICAgICAgaWYgKGtleVByZXNzZWQgPT09ICdEZWNpbWFsJykge1xyXG4gICAgICAgICAgICBrZXlQcmVzc2VkID0gJy4nO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY3VycmVudDogc3RyaW5nID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IGZpcnN0UGFydDogc3RyaW5nID0gY3VycmVudC5zdWJzdHJpbmcoMCwgdGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQgfHwgMCk7XHJcbiAgICAgICAgY29uc3Qgc2Vjb25kUGFydDogc3RyaW5nID0gY3VycmVudC5zdWJzdHJpbmcodGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uRW5kIHx8IDApO1xyXG4gICAgICAgIGNvbnN0IG5leHQ6IHN0cmluZyA9IChmaXJzdFBhcnQuY29uY2F0KGtleVByZXNzZWQpICsgc2Vjb25kUGFydCkucmVwbGFjZSgvLC9nLCAnJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlZ0V4ID0gdGhpcy5nZXRSZWdFeCgpO1xyXG5cclxuICAgICAgICBjb25zdCB2YWx1ZSA9IG5leHQuc3BsaXQoJy4nKTtcclxuICAgICAgICBpZiAobmV4dCAmJiAhU3RyaW5nKG5leHQpLm1hdGNoKHJlZ0V4KSB8fCAodmFsdWVbMF0ubGVuZ3RoID4gdGhpcy5fbWF4ICYmIHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0ID09PSB0aGlzLl9mb3JtRWxlbWVudC5zZWxlY3Rpb25FbmQpIHx8ICh0aGlzLl9kZWNpbWFsID4gMCAmJiB2YWx1ZS5sZW5ndGggPT09IDIgJiYgKHZhbHVlWzFdLmxlbmd0aCA+IHRoaXMuX2RlY2ltYWwgJiYgdGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQgPT09IHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvbkVuZCkpKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9vbGRTZWxlY3Rpb25TdGFydCA9IHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX29sZFZhbHVlID0gdGhpcy5fZm9ybUVsZW1lbnQudmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXHJcbiAgICBwdWJsaWMgb25DbGljayhldmVudDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuX29sZFNlbGVjdGlvblN0YXJ0ID0gdGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX29sZFZhbHVlID0gdGhpcy5fZm9ybUVsZW1lbnQudmFsdWU7XHJcbiAgICAgICAgdGhpcy5fb2xkVmFsdWVGb3JEZXRlY3RDaGFuZ2UgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgQEhvc3RMaXN0ZW5lcignaW5wdXQnLCBbJyRldmVudCddKVxyXG4gICAgcHVibGljIG9uSW5wdXQoZXZlbnQ6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG5cclxuICAgICAgICBpZiAodmFsdWUgJiYgIVN0cmluZyh2YWx1ZSkucmVwbGFjZSgvLC9nLCAnJykubWF0Y2godGhpcy5nZXRSZWdFeCgpKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9mb3JtRWxlbWVudC52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9kZXRlY3RCYWNrc3BhY2UgfHwgdGhpcy5fZGV0ZWN0RGVsZXRlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZm9ybUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9vbGRTZWxlY3Rpb25TdGFydCA9IHRoaXMuX2Zvcm1FbGVtZW50LnNlbGVjdGlvblN0YXJ0IC0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuX29sZFZhbHVlID0gdGhpcy5fZm9ybUVsZW1lbnQudmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5vblZhbHVlQ2hhbmdlKHZhbHVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2JsdXInLCBbJyRldmVudCddKVxyXG4gICAgcHVibGljIG9uQmx1cihldmVudDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgbGV0IHZhbHVlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG5cclxuICAgICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCAmJiB0aGlzLl9kZWNpbWFsID4gMCkge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoLywvZywgJycpO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSkudG9GaXhlZCh0aGlzLl9kZWNpbWFsKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICB0aGlzLl9mb3JtRWxlbWVudC52YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL1xcQig/PShcXGR7M30pKyg/IVxcZCkpL2csICcsJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMub25Ub3VjaCgpO1xyXG5cclxuICAgICAgICAvLyBGaXggYnVnIG9uIEludGVybmV0IEV4cGxvcmVyIGFuZCBNaWNyb3NvZnQgRWRnZSBub3QgZmlyZSBjaGFuZ2UgZXZlbnQgd2hlbiBzZXQgdmFsdWUgdG8gaW5wdXQgZWxlbWVudCBieSBqYXZhc2NyaXB0LlxyXG4gICAgICAgIC8vICoqKiAyNC8xMi8yMDIxICoqKiBBZGQgSU9TIERldmljZSBub3QgZmlyZSBjaGFuZ2UgZXZlbnRcclxuICAgICAgICBjb25zdCBpc0lFT3JFZGdlID0gL21zaWVcXHN8dHJpZGVudFxcL3xlZGdlXFwvL2kudGVzdCh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkgfHwgdGhpcy5kZXRlY3RJT1MoKTtcclxuICAgICAgICBpZiAoaXNJRU9yRWRnZSAmJiAodmFsdWUgIT09IHRoaXMuX29sZFZhbHVlRm9yRGV0ZWN0Q2hhbmdlKSkge1xyXG4gICAgICAgICAgICBjb25zdCBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpO1xyXG4gICAgICAgICAgICBldnQuaW5pdEV2ZW50KCdjaGFuZ2UnLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KGV2dCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZGV0ZWN0SU9TKCkge1xyXG4gICAgICAgIHJldHVybiBbJ01hY0ludGVsJywgJ01hY1BQQycsICdNYWM2OEsnLCAnTWFjaW50b3NoJywgJ2lQYWQgU2ltdWxhdG9yJywgJ2lQaG9uZSBTaW11bGF0b3InLCAnaVBvZCBTaW11bGF0b3InLCAnaVBhZCcsICdpUGhvbmUnLCAnaVBvZCcsICdQaWtlIHY3LjYgcmVsZWFzZSA5MicsICdQaWtlIHY3LjggcmVsZWFzZSA1MTcnXS5pbmNsdWRlcyhuYXZpZ2F0b3IucGxhdGZvcm0pIHx8IChuYXZpZ2F0b3IudXNlckFnZW50LmluY2x1ZGVzKCdNYWMnKSAmJiAnb250b3VjaGVuZCcgaW4gZG9jdW1lbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3NDdXJzb3JQb3NpdGlvbihfb2xkVmFsdWU6IHN0cmluZywgX29sZFNlbGVjdGlvblN0YXJ0OiBudW1iZXIsIF9uZXdWYWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IF9vbGRUb3RhbENvbW1hID0gMDtcclxuICAgICAgICBsZXQgX25ld1RvdGFsQ29tbWEgPSAwO1xyXG4gICAgICAgIGlmIChfbmV3VmFsdWUpIHtcclxuICAgICAgICAgICAgX29sZFZhbHVlID0gX29sZFZhbHVlLnN1YnN0cmluZygwLCBfb2xkU2VsZWN0aW9uU3RhcnQpO1xyXG4gICAgICAgICAgICBfb2xkVG90YWxDb21tYSA9IChfb2xkVmFsdWUubWF0Y2goLywvZykgfHwgW10pLmxlbmd0aDtcclxuICAgICAgICAgICAgX25ld1ZhbHVlID0gX25ld1ZhbHVlLnN1YnN0cmluZygwLCBfb2xkU2VsZWN0aW9uU3RhcnQgKyAxKTtcclxuICAgICAgICAgICAgX25ld1RvdGFsQ29tbWEgPSAoX25ld1ZhbHVlLm1hdGNoKC8sL2cpIHx8IFtdKS5sZW5ndGg7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Q3Vyc29yQXQoX29sZFNlbGVjdGlvblN0YXJ0ICsgMSArIChfbmV3VG90YWxDb21tYSAtIF9vbGRUb3RhbENvbW1hKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldEN1cnNvckF0KHBvc2l0aW9uOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5fZm9ybUVsZW1lbnQuc2V0U2VsZWN0aW9uUmFuZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5fZm9ybUVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgICAgICAgdGhpcy5fZm9ybUVsZW1lbnQuc2V0U2VsZWN0aW9uUmFuZ2UocG9zaXRpb24sIHBvc2l0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XHJcblxyXG4gICAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIHZhbHVlICE9PSAnJykge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mICh2YWx1ZSkgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoLywvZywgJycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9kZWNpbWFsID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBOdW1iZXIodmFsdWUpLnRvRml4ZWQodGhpcy5fZGVjaW1hbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b1N0cmluZygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5vblZhbHVlQ2hhbmdlKHZhbHVlLCBmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJPbkNoYW5nZShmbjogYW55KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5vbkNoYW5nZSA9IGZuO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLm9uVG91Y2ggPSBmbjtcclxuICAgIH1cclxuXHJcbiAgICBzZXREaXNhYmxlZFN0YXRlPyh2YWx1ZTogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2Zvcm1FbGVtZW50LmRpc2FibGVkID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvblZhbHVlQ2hhbmdlKG5ld1ZhbHVlOiBzdHJpbmcsIGN1cnNvcjogYm9vbGVhbiA9IHRydWUpIHtcclxuXHJcbiAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSB0aGlzLl9kaXNwbGF5VmFsdWUpIHtcclxuICAgICAgICAgICAgbGV0IHZhbHVlO1xyXG5cclxuICAgICAgICAgICAgaWYgKCh0eXBlb2YgKG5ld1ZhbHVlKSAhPT0gJ3N0cmluZycpICYmIG5ld1ZhbHVlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG5ld1ZhbHVlICsgJyc7XHJcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IE51bWJlcihuZXdWYWx1ZSkudG9GaXhlZCh0aGlzLl9kZWNpbWFsKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoKG5ld1ZhbHVlID09IG51bGwpIHx8IChuZXdWYWx1ZS50cmltKCkgPT09ICcnKSkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSAnJztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gbmV3VmFsdWUucmVwbGFjZSgvLC9nLCAnJyk7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMucmVtb3ZlTGVhZGluZ1plcm8odmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuX2Zvcm1hdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fZGlzcGxheVZhbHVlID0gdmFsdWUucmVwbGFjZSgvXFxCKD89KFxcZHszfSkrKD8hXFxkKSkvZywgJywnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2Rpc3BsYXlWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1FbGVtZW50LnZhbHVlID0gdGhpcy5fZGlzcGxheVZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcclxuICAgICAgICAgICAgaWYgKGN1cnNvcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ3Vyc29yUG9zaXRpb24odGhpcy5fb2xkVmFsdWUsIHRoaXMuX29sZFNlbGVjdGlvblN0YXJ0LCB0aGlzLl9kaXNwbGF5VmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlTGVhZGluZ1plcm8odmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHZhbHVlLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgY29uc3QgY29udmVydFZhbCA9ICt2YWx1ZTtcclxuICAgICAgICAgICAgdmFsdWUgPSBjb252ZXJ0VmFsLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJlZ0V4KCk6IFJlZ0V4cCB7XHJcbiAgICAgICAgcmV0dXJuICh0aGlzLl9kZWNpbWFsID4gMCkgPyB0aGlzLl9yZWdFeE51bWJlckFuZERlY2ltYWwgOiAodGhpcy5pc1plcm8gPT09IHRydWUgPyB0aGlzLl9yZWdFeE51bWJlciA6IHRoaXMuX3JlZ0V4TnVtYmVyTm90WmVybyk7XHJcbiAgICB9XHJcbn1cclxuIl19